package reservationops

import (
	"context"
	"testing"

	"github.com/stretchr/testify/mock"

	"library-service/internal/domain/reservation"
	"library-service/pkg/errors"
	"library-service/test/testutil"
)

// Helper function to create a valid reservation entity
func validReservation() reservation.Reservation {
	return reservation.Reservation{
		ID:       "reservation-123",
		BookID:   "book-123",
		MemberID: "member-123",
		Status:   reservation.StatusPending,
	}
}

func TestGetReservationUseCase_Execute(t *testing.T) {
	tests := []struct {
		name         string
		request      GetReservationRequest
		setupMocks   func(*mockReservationRepository)
		expectError  bool
		errorCheck   func(*testing.T, error)
		validateFunc func(*testing.T, GetReservationResponse)
	}{
		{
			name: "successful retrieval",
			request: GetReservationRequest{
				ReservationID: "reservation-123",
			},
			setupMocks: func(repo *mockReservationRepository) {
				reservationEntity := validReservation()
				reservationEntity.ID = "reservation-123"

				repo.On("GetByID", mock.Anything, "reservation-123").
					Return(reservationEntity, nil).
					Once()
			},
			expectError: false,
			validateFunc: func(t *testing.T, resp GetReservationResponse) {
				testutil.AssertEqual(t, "reservation-123", resp.ID)
				testutil.AssertEqual(t, "book-123", resp.BookID)
				testutil.AssertEqual(t, "member-123", resp.MemberID)
				testutil.AssertEqual(t, reservation.StatusPending, resp.Status)
			},
		},
		{
			name: "reservation not found",
			request: GetReservationRequest{
				ReservationID: "non-existent",
			},
			setupMocks: func(repo *mockReservationRepository) {
				repo.On("GetByID", mock.Anything, "non-existent").
					Return(reservation.Reservation{}, errors.ErrNotFound).
					Once()
			},
			expectError: true,
			errorCheck: func(t *testing.T, err error) {
				testutil.AssertError(t, err)
				testutil.AssertStringContains(t, err.Error(), "not found")
			},
		},
		{
			name: "repository error",
			request: GetReservationRequest{
				ReservationID: "reservation-error",
			},
			setupMocks: func(repo *mockReservationRepository) {
				repo.On("GetByID", mock.Anything, "reservation-error").
					Return(reservation.Reservation{}, errors.ErrDatabase).
					Once()
			},
			expectError: true,
			errorCheck: func(t *testing.T, err error) {
				testutil.AssertError(t, err)
			},
		},
		{
			name: "cancelled reservation",
			request: GetReservationRequest{
				ReservationID: "reservation-cancelled",
			},
			setupMocks: func(repo *mockReservationRepository) {
				reservationEntity := validReservation()
				reservationEntity.ID = "reservation-cancelled"
				reservationEntity.Status = reservation.StatusCancelled

				repo.On("GetByID", mock.Anything, "reservation-cancelled").
					Return(reservationEntity, nil).
					Once()
			},
			expectError: false,
			validateFunc: func(t *testing.T, resp GetReservationResponse) {
				testutil.AssertEqual(t, "reservation-cancelled", resp.ID)
				testutil.AssertEqual(t, reservation.StatusCancelled, resp.Status)
			},
		},
		{
			name: "fulfilled reservation",
			request: GetReservationRequest{
				ReservationID: "reservation-fulfilled",
			},
			setupMocks: func(repo *mockReservationRepository) {
				reservationEntity := validReservation()
				reservationEntity.ID = "reservation-fulfilled"
				reservationEntity.Status = reservation.StatusFulfilled

				repo.On("GetByID", mock.Anything, "reservation-fulfilled").
					Return(reservationEntity, nil).
					Once()
			},
			expectError: false,
			validateFunc: func(t *testing.T, resp GetReservationResponse) {
				testutil.AssertEqual(t, "reservation-fulfilled", resp.ID)
				testutil.AssertEqual(t, reservation.StatusFulfilled, resp.Status)
			},
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			// Setup mocks
			mockRepo := new(mockReservationRepository)
			tt.setupMocks(mockRepo)

			// Create use case
			uc := NewGetReservationUseCase(mockRepo)

			// Execute
			ctx := context.Background()
			result, err := uc.Execute(ctx, tt.request)

			// Assert
			if tt.expectError {
				testutil.AssertError(t, err)
				if tt.errorCheck != nil {
					tt.errorCheck(t, err)
				}
			} else {
				testutil.AssertNoError(t, err)
				if tt.validateFunc != nil {
					tt.validateFunc(t, result)
				}
			}

			// Verify all expectations were met
			mockRepo.AssertExpectations(t)
		})
	}
}
