package paymentops

import (
	"context"
	"testing"

	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/mock"

	"library-service/internal/domain/payment"
	"library-service/pkg/errors"
)

func TestDeleteSavedCardUseCase_Execute(t *testing.T) {
	tests := []struct {
		name        string
		request     DeleteSavedCardRequest
		setupMock   func(*mockSavedCardRepository)
		wantErr     bool
		wantErrType error
		wantSuccess bool
	}{
		{
			name: "successfully delete card - authorized",
			request: DeleteSavedCardRequest{
				CardID:   "card-1",
				MemberID: "member-1",
			},
			setupMock: func(repo *mockSavedCardRepository) {
				// Card exists and belongs to member
				card := payment.NewSavedCard(
					"member-1",
					"token-123",
					"**** 1234",
					"Visa",
					12,
					2025,
				)
				card.ID = "card-1"
				card.IsDefault = true

				repo.On("GetByID", mock.Anything, "card-1").
					Return(card, nil)

				repo.On("Delete", mock.Anything, "card-1").
					Return(nil)
			},
			wantErr:     false,
			wantSuccess: true,
		},
		{
			name: "card not found",
			request: DeleteSavedCardRequest{
				CardID:   "card-999",
				MemberID: "member-1",
			},
			setupMock: func(repo *mockSavedCardRepository) {
				// Card does not exist
				repo.On("GetByID", mock.Anything, "card-999").
					Return(payment.SavedCard{}, errors.ErrNotFound)
			},
			wantErr:     true,
			wantErrType: errors.ErrNotFound,
		},
		{
			name: "unauthorized delete - card belongs to different member",
			request: DeleteSavedCardRequest{
				CardID:   "card-1",
				MemberID: "member-2",
			},
			setupMock: func(repo *mockSavedCardRepository) {
				// Card exists but belongs to member-1, not member-2
				card := payment.NewSavedCard(
					"member-1",
					"token-123",
					"**** 1234",
					"Visa",
					12,
					2025,
				)
				card.ID = "card-1"
				card.IsDefault = true

				repo.On("GetByID", mock.Anything, "card-1").
					Return(card, nil)

				// Delete should NOT be called
			},
			wantErr:     true,
			wantErrType: errors.ErrNotFound,
		},
		{
			name: "error retrieving card",
			request: DeleteSavedCardRequest{
				CardID:   "card-1",
				MemberID: "member-1",
			},
			setupMock: func(repo *mockSavedCardRepository) {
				// Database error when retrieving card
				repo.On("GetByID", mock.Anything, "card-1").
					Return(payment.SavedCard{}, errors.ErrDatabase)
			},
			wantErr:     true,
			wantErrType: errors.ErrNotFound, // Wrapped as ErrNotFound
		},
		{
			name: "error deleting card",
			request: DeleteSavedCardRequest{
				CardID:   "card-1",
				MemberID: "member-1",
			},
			setupMock: func(repo *mockSavedCardRepository) {
				// Card exists and belongs to member
				card := payment.NewSavedCard(
					"member-1",
					"token-123",
					"**** 1234",
					"Visa",
					12,
					2025,
				)
				card.ID = "card-1"

				repo.On("GetByID", mock.Anything, "card-1").
					Return(card, nil)

				// Database error when deleting
				repo.On("Delete", mock.Anything, "card-1").
					Return(errors.ErrDatabase)
			},
			wantErr:     true,
			wantErrType: errors.ErrDatabase,
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			// Setup
			mockRepo := new(mockSavedCardRepository)
			tt.setupMock(mockRepo)

			uc := NewDeleteSavedCardUseCase(mockRepo)
			ctx := context.Background()

			// Execute
			result, err := uc.Execute(ctx, tt.request)

			// Assert error
			if tt.wantErr {
				assert.Error(t, err)
				if tt.wantErrType != nil {
					assert.ErrorIs(t, err, tt.wantErrType)
				}
			} else {
				assert.NoError(t, err)
				assert.Equal(t, tt.wantSuccess, result.Success)
			}

			// Verify mock expectations
			mockRepo.AssertExpectations(t)
		})
	}
}
