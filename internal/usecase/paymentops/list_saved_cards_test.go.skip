package paymentops

import (
	"context"
	"testing"

	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/mock"

	"library-service/internal/domain/payment"
	"library-service/pkg/errors"
)

func TestListSavedCardsUseCase_Execute(t *testing.T) {
	tests := []struct {
		name          string
		request       ListSavedCardsRequest
		setupMock     func(*mockSavedCardRepository)
		wantErr       bool
		wantErrType   error
		wantCardCount int
	}{
		{
			name: "successfully list multiple cards",
			request: ListSavedCardsRequest{
				MemberID: "member-1",
			},
			setupMock: func(repo *mockSavedCardRepository) {
				card1 := payment.NewSavedCard(
					"member-1",
					"token-123",
					"**** 1234",
					"Visa",
					12,
					2025,
				)
				card1.ID = "card-1"
				card1.IsDefault = true

				card2 := payment.NewSavedCard(
					"member-1",
					"token-456",
					"**** 5678",
					"MasterCard",
					6,
					2026,
				)
				card2.ID = "card-2"
				card2.IsDefault = false

				card3 := payment.NewSavedCard(
					"member-1",
					"token-789",
					"**** 9012",
					"Amex",
					3,
					2027,
				)
				card3.ID = "card-3"
				card3.IsDefault = false

				repo.On("ListByMemberID", mock.Anything, "member-1").
					Return([]payment.SavedCard{card1, card2, card3}, nil)
			},
			wantErr:       false,
			wantCardCount: 3,
		},
		{
			name: "successfully list single card",
			request: ListSavedCardsRequest{
				MemberID: "member-2",
			},
			setupMock: func(repo *mockSavedCardRepository) {
				card := payment.NewSavedCard(
					"member-2",
					"token-999",
					"**** 3456",
					"Visa",
					9,
					2028,
				)
				card.ID = "card-1"
				card.IsDefault = true

				repo.On("ListByMemberID", mock.Anything, "member-2").
					Return([]payment.SavedCard{card}, nil)
			},
			wantErr:       false,
			wantCardCount: 1,
		},
		{
			name: "successfully list no cards - empty list",
			request: ListSavedCardsRequest{
				MemberID: "member-3",
			},
			setupMock: func(repo *mockSavedCardRepository) {
				// Member has no saved cards
				repo.On("ListByMemberID", mock.Anything, "member-3").
					Return([]payment.SavedCard{}, nil)
			},
			wantErr:       false,
			wantCardCount: 0,
		},
		{
			name: "error from repository",
			request: ListSavedCardsRequest{
				MemberID: "member-4",
			},
			setupMock: func(repo *mockSavedCardRepository) {
				// Database error
				repo.On("ListByMemberID", mock.Anything, "member-4").
					Return([]payment.SavedCard{}, errors.ErrDatabase)
			},
			wantErr:     true,
			wantErrType: errors.ErrDatabase,
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			// Setup
			mockRepo := new(mockSavedCardRepository)
			tt.setupMock(mockRepo)

			uc := NewListSavedCardsUseCase(mockRepo)
			ctx := context.Background()

			// Execute
			result, err := uc.Execute(ctx, tt.request)

			// Assert error
			if tt.wantErr {
				assert.Error(t, err)
				if tt.wantErrType != nil {
					assert.ErrorIs(t, err, tt.wantErrType)
				}
			} else {
				assert.NoError(t, err)
				assert.Len(t, result.Cards, tt.wantCardCount)

				// Verify all cards belong to the correct member
				for _, card := range result.Cards {
					assert.Equal(t, tt.request.MemberID, card.MemberID)
				}

				// If cards exist, verify at least one is default
				if tt.wantCardCount > 0 {
					hasDefault := false
					for _, card := range result.Cards {
						if card.IsDefault {
							hasDefault = true
							break
						}
					}
					assert.True(t, hasDefault, "at least one card should be marked as default")
				}
			}

			// Verify mock expectations
			mockRepo.AssertExpectations(t)
		})
	}
}
