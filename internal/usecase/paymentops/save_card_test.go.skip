package paymentops

import (
	"context"
	"testing"

	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/mock"

	"library-service/internal/domain/payment"
	"library-service/pkg/errors"
)

// Mock for SavedCardRepository
type mockSavedCardRepository struct {
	mock.Mock
}

func (m *mockSavedCardRepository) Create(ctx context.Context, card payment.SavedCard) (string, error) {
	args := m.Called(ctx, card)
	return args.String(0), args.Error(1)
}

func (m *mockSavedCardRepository) GetByID(ctx context.Context, id string) (payment.SavedCard, error) {
	args := m.Called(ctx, id)
	return args.Get(0).(payment.SavedCard), args.Error(1)
}

func (m *mockSavedCardRepository) GetByCardToken(ctx context.Context, token string) (payment.SavedCard, error) {
	args := m.Called(ctx, token)
	return args.Get(0).(payment.SavedCard), args.Error(1)
}

func (m *mockSavedCardRepository) ListByMemberID(ctx context.Context, memberID string) ([]payment.SavedCard, error) {
	args := m.Called(ctx, memberID)
	return args.Get(0).([]payment.SavedCard), args.Error(1)
}

func (m *mockSavedCardRepository) Delete(ctx context.Context, id string) error {
	args := m.Called(ctx, id)
	return args.Error(0)
}

func (m *mockSavedCardRepository) SetDefault(ctx context.Context, memberID, cardID string) error {
	args := m.Called(ctx, memberID, cardID)
	return args.Error(0)
}

func (m *mockSavedCardRepository) SetAsDefault(ctx context.Context, memberID, cardID string) error {
	args := m.Called(ctx, memberID, cardID)
	return args.Error(0)
}

func (m *mockSavedCardRepository) GetDefault(ctx context.Context, memberID string) (payment.SavedCard, error) {
	args := m.Called(ctx, memberID)
	return args.Get(0).(payment.SavedCard), args.Error(1)
}

func (m *mockSavedCardRepository) GetDefaultCard(ctx context.Context, memberID string) (payment.SavedCard, error) {
	args := m.Called(ctx, memberID)
	return args.Get(0).(payment.SavedCard), args.Error(1)
}

func (m *mockSavedCardRepository) Update(ctx context.Context, id string, card payment.SavedCard) error {
	args := m.Called(ctx, id, card)
	return args.Error(0)
}

func (m *mockSavedCardRepository) Deactivate(ctx context.Context, id string) error {
	args := m.Called(ctx, id)
	return args.Error(0)
}

func TestSaveCardUseCase_Execute(t *testing.T) {
	tests := []struct {
		name          string
		request       SaveCardRequest
		setupMock     func(*mockSavedCardRepository)
		wantErr       bool
		wantErrType   error
		wantIsDefault bool
		wantCardMask  string
	}{
		{
			name: "successfully save first card - should be default",
			request: SaveCardRequest{
				MemberID:    "member-1",
				CardToken:   "token-123",
				CardMask:    "**** 1234",
				CardType:    "Visa",
				ExpiryMonth: 12,
				ExpiryYear:  2025,
			},
			setupMock: func(repo *mockSavedCardRepository) {
				// Card doesn't exist yet
				repo.On("GetByCardToken", mock.Anything, "token-123").
					Return(payment.SavedCard{}, errors.ErrNotFound)

				// No existing cards (first card)
				repo.On("ListByMemberID", mock.Anything, "member-1").
					Return([]payment.SavedCard{}, nil)

				// Successfully create card
				repo.On("Create", mock.Anything, mock.MatchedBy(func(card payment.SavedCard) bool {
					return card.MemberID == "member-1" &&
						card.CardToken == "token-123" &&
						card.IsDefault == true // First card should be default
				})).Return("card-id-1", nil)
			},
			wantErr:       false,
			wantIsDefault: true,
			wantCardMask:  "**** 1234",
		},
		{
			name: "successfully save second card - should not be default",
			request: SaveCardRequest{
				MemberID:    "member-1",
				CardToken:   "token-456",
				CardMask:    "**** 5678",
				CardType:    "MasterCard",
				ExpiryMonth: 6,
				ExpiryYear:  2026,
			},
			setupMock: func(repo *mockSavedCardRepository) {
				// Card doesn't exist yet
				repo.On("GetByCardToken", mock.Anything, "token-456").
					Return(payment.SavedCard{}, errors.ErrNotFound)

				// Member already has one card
				existingCard := payment.NewSavedCard(
					"member-1",
					"token-123",
					"**** 1234",
					"Visa",
					12,
					2025,
				)
				existingCard.IsDefault = true

				repo.On("ListByMemberID", mock.Anything, "member-1").
					Return([]payment.SavedCard{existingCard}, nil)

				// Successfully create card
				repo.On("Create", mock.Anything, mock.MatchedBy(func(card payment.SavedCard) bool {
					return card.MemberID == "member-1" &&
						card.CardToken == "token-456" &&
						card.IsDefault == false // Second card should not be default
				})).Return("card-id-2", nil)
			},
			wantErr:       false,
			wantIsDefault: false,
			wantCardMask:  "**** 5678",
		},
		{
			name: "card already exists - return existing",
			request: SaveCardRequest{
				MemberID:    "member-1",
				CardToken:   "token-123",
				CardMask:    "**** 1234",
				CardType:    "Visa",
				ExpiryMonth: 12,
				ExpiryYear:  2025,
			},
			setupMock: func(repo *mockSavedCardRepository) {
				// Card already exists
				existingCard := payment.NewSavedCard(
					"member-1",
					"token-123",
					"**** 1234",
					"Visa",
					12,
					2025,
				)
				existingCard.ID = "existing-card-id"
				existingCard.IsDefault = true

				repo.On("GetByCardToken", mock.Anything, "token-123").
					Return(existingCard, nil)

				// Should not call Create or ListByMemberID
			},
			wantErr:       false,
			wantIsDefault: true,
			wantCardMask:  "**** 1234",
		},
		{
			name: "error checking existing cards",
			request: SaveCardRequest{
				MemberID:    "member-1",
				CardToken:   "token-789",
				CardMask:    "**** 9012",
				CardType:    "Visa",
				ExpiryMonth: 3,
				ExpiryYear:  2027,
			},
			setupMock: func(repo *mockSavedCardRepository) {
				// Card doesn't exist
				repo.On("GetByCardToken", mock.Anything, "token-789").
					Return(payment.SavedCard{}, errors.ErrNotFound)

				// Error checking existing cards
				repo.On("ListByMemberID", mock.Anything, "member-1").
					Return([]payment.SavedCard{}, errors.ErrDatabase)
			},
			wantErr:     true,
			wantErrType: errors.ErrDatabase,
		},
		{
			name: "error creating card",
			request: SaveCardRequest{
				MemberID:    "member-1",
				CardToken:   "token-999",
				CardMask:    "**** 3456",
				CardType:    "Amex",
				ExpiryMonth: 9,
				ExpiryYear:  2028,
			},
			setupMock: func(repo *mockSavedCardRepository) {
				// Card doesn't exist
				repo.On("GetByCardToken", mock.Anything, "token-999").
					Return(payment.SavedCard{}, errors.ErrNotFound)

				// No existing cards
				repo.On("ListByMemberID", mock.Anything, "member-1").
					Return([]payment.SavedCard{}, nil)

				// Error creating card
				repo.On("Create", mock.Anything, mock.Anything).
					Return("", errors.ErrDatabase)
			},
			wantErr:     true,
			wantErrType: errors.ErrDatabase,
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			// Setup
			mockRepo := new(mockSavedCardRepository)
			tt.setupMock(mockRepo)

			uc := NewSaveCardUseCase(mockRepo)
			ctx := context.Background()

			// Execute
			result, err := uc.Execute(ctx, tt.request)

			// Assert error
			if tt.wantErr {
				assert.Error(t, err)
				if tt.wantErrType != nil {
					assert.ErrorIs(t, err, tt.wantErrType)
				}
			} else {
				assert.NoError(t, err)
				assert.NotEmpty(t, result.CardID)
				assert.Equal(t, tt.wantCardMask, result.CardMask)
				assert.Equal(t, tt.request.CardType, result.CardType)
				assert.Equal(t, tt.request.ExpiryMonth, result.ExpiryMonth)
				assert.Equal(t, tt.request.ExpiryYear, result.ExpiryYear)
				assert.Equal(t, tt.wantIsDefault, result.IsDefault)
			}

			// Verify mock expectations
			mockRepo.AssertExpectations(t)
		})
	}
}
