#!/bin/bash
# Pre-commit hook for Library Management System
# Ensures code quality before committing

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}üîç Running pre-commit checks...${NC}"
echo ""

# Step 1: Format check
echo -e "${YELLOW}üìù Checking code formatting...${NC}"
UNFORMATTED=$(gofmt -l . 2>/dev/null | grep -v vendor || true)
if [ -n "$UNFORMATTED" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Code not formatted. Running gofmt...${NC}"
    gofmt -w .
    # Also run goimports if available
    if command -v goimports &> /dev/null; then
        goimports -w .
    fi
    git add .
    echo -e "${GREEN}‚úì Code formatted${NC}"
else
    echo -e "${GREEN}‚úì Code is properly formatted${NC}"
fi
echo ""

# Step 2: Run go vet
echo -e "${YELLOW}üî¨ Running go vet...${NC}"
if go vet ./... 2>&1 | grep -v "^#" | grep -v vendor; then
    echo -e "${RED}‚ùå go vet found issues. Please fix them before committing.${NC}"
    exit 1
fi
echo -e "${GREEN}‚úì go vet passed${NC}"
echo ""

# Step 3: Run unit tests (fast)
echo -e "${YELLOW}üß™ Running unit tests...${NC}"
if ! go test -short ./... > /dev/null 2>&1; then
    echo -e "${RED}‚ùå Unit tests failed. Run 'make test-unit' to see details.${NC}"
    echo -e "${YELLOW}Tip: Fix failing tests before committing${NC}"
    exit 1
fi
echo -e "${GREEN}‚úì Unit tests passed${NC}"
echo ""

# Clean up any log files created during tests
find ./internal -name "service.log" -type f -delete 2>/dev/null || true

# Step 4: Check for log files
echo -e "${YELLOW}üóëÔ∏è  Checking for log files in source code...${NC}"
LOG_FILES=$(find . -name "*.log" -type f -not -path "./vendor/*" -not -path "./node_modules/*" -not -path "./logs/*" -not -path "./bin/*" 2>/dev/null || true)
if [ -n "$LOG_FILES" ]; then
    echo -e "${RED}‚ùå Log files found in source code:${NC}"
    echo "$LOG_FILES"
    echo ""
    echo -e "${YELLOW}Run: make clean-logs${NC}"
    exit 1
fi
echo -e "${GREEN}‚úì No log files in source code${NC}"
echo ""

# Step 5: Check for debug statements (optional warning)
echo -e "${YELLOW}üîç Checking for debug statements...${NC}"
DEBUG_PATTERNS="fmt.Println|log.Println|console.log|debugger"
DEBUG_FILES=$(git diff --cached --name-only | grep "\.go$" | xargs grep -l -E "$DEBUG_PATTERNS" 2>/dev/null || true)
if [ -n "$DEBUG_FILES" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: Debug statements found in:${NC}"
    echo "$DEBUG_FILES"
    echo -e "${YELLOW}Consider removing before committing (continuing anyway)${NC}"
else
    echo -e "${GREEN}‚úì No debug statements found${NC}"
fi
echo ""

# All checks passed
echo -e "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
echo -e "${GREEN}Proceeding with commit...${NC}"
echo ""

exit 0
